{"version":3,"file":"watermark.js","sources":["../src/index.ts"],"sourcesContent":["export interface WatermarkOptions {\n  /** watermark text content */\n  content?: string | string[];\n  /**\n   * When the watermark is drawn, the rotation angle, in `Â°`. @default `-22`\n   */\n  rotate?: number;\n  /**\n   * High-definition print image source, for high-definition screen display,\n   * it is recommended to use 2x or 3x image, and priority to use image rendering watermark.\n   */\n  image?: string;\n  /** Horizontal spacing between watermarks. @default `212` */\n  gapX?: number;\n  /** vertical spacing between watermarks. @default `222` */\n  gapY?: number;\n  /** width of watermark. @default `120` */\n  width?: number;\n  /** height of watermark @default `64` */\n  height?: number;\n  /**\n   * The vertical offset of the watermark drawn on the canvas.\n   * Normally, the watermark is drawn in the middle position, ie `offsetTop = gapY / 2`\n   */\n  offsetLeft?: number;\n  /**\n   * The horizontal offset of the watermark drawn on the canvas, under normal circumstances,\n   * the watermark is drawn in the middle position, ie `offsetTop = gapX / 2`\n   */\n  offsetTop?: number;\n  /** text size @default `16` */\n  fontSize?: number;\n  /** text family @default `sans-serif` */\n  fontFamily?: string;\n  /** text weight @default `normal` */\n  fontWeight?: 'normal' | 'light' | 'weight' | number;\n  /** text color @default `rgba(0,0,0,.15)` */\n  fontColor?: string;\n  /** text style */\n  fontStyle?: CanvasFillStrokeStyles['fillStyle'];\n}\n\n/**\n * Returns the ratio of the current display device's physical pixel resolution to CSS pixel resolution\n * @param context\n * @returns\n */\nconst getPixelRatio = (context: any) => {\n  if (!context) {\n    return 1;\n  }\n  const backingStore =\n    context.backingStorePixelRatio ||\n    context.webkitBackingStorePixelRatio ||\n    context.mozBackingStorePixelRatio ||\n    context.msBackingStorePixelRatio ||\n    context.oBackingStorePixelRatio ||\n    context.backingStorePixelRatio ||\n    1;\n  return (window.devicePixelRatio || 1) / backingStore;\n};\n\nexport default class Watermark {\n  option: WatermarkOptions = {\n    gapX: 212,\n    gapY: 222,\n    width: 120,\n    height: 64,\n    rotate: -22,\n    fontStyle: 'normal',\n    fontWeight: 'normal',\n    fontColor: 'rgba(0,0,0,.15)',\n    fontSize: 16,\n    fontFamily: 'sans-serif',\n  };\n  constructor(options: WatermarkOptions) {\n    this.option = { ...this.option, ...options };\n  }\n  async create(): Promise<string> {\n    const {\n      image = '',\n      content = '',\n      gapX = 212,\n      gapY = 222,\n      width = 120,\n      height = 64,\n      rotate = -22,\n      fontStyle = 'normal',\n      fontWeight = 'normal',\n      fontColor = 'rgba(0,0,0,.15)',\n      fontSize = 16,\n      fontFamily = 'sans-serif',\n      offsetLeft,\n      offsetTop,\n    } = this.option;\n    const canvas = document.createElement('canvas');\n    const ctx = canvas.getContext('2d');\n    const ratio = getPixelRatio(ctx);\n    const canvasWidth = `${(gapX + width) * ratio}px`;\n    const canvasHeight = `${(gapY + height) * ratio}px`;\n    const canvasOffsetLeft = offsetLeft || gapX / 2;\n    const canvasOffsetTop = offsetTop || gapY / 2;\n    canvas.setAttribute('width', canvasWidth);\n    canvas.setAttribute('height', canvasHeight);\n    return new Promise(async (resolve, reject) => {\n      if (ctx) {\n        ctx.translate(canvasOffsetLeft * ratio, canvasOffsetTop * ratio);\n        ctx.rotate((Math.PI / 180) * Number(rotate));\n        const markWidth = width * ratio;\n        const markHeight = height * ratio;\n        if (image) {\n          const img = new Image();\n          img.crossOrigin = 'anonymous';\n          img.referrerPolicy = 'no-referrer';\n          img.src = image;\n          img.onload = async () => {\n            ctx.drawImage(img, 0, 0, markWidth, markHeight);\n            return resolve(canvas.toDataURL());\n          };\n          img.onerror = (error) => {\n            return reject(error);\n          };\n        } else if (content) {\n          const markSize = Number(fontSize) * ratio;\n          ctx.font = `${fontStyle} normal ${fontWeight} ${markSize}px/${markHeight}px ${fontFamily}`;\n          ctx.fillStyle = fontColor;\n          if (Array.isArray(content)) {\n            content?.forEach((item: string, index: number) => ctx.fillText(item, 0, index * 50));\n          } else {\n            ctx.fillText(content, 0, 0);\n          }\n          return resolve(canvas.toDataURL());\n        }\n      } else {\n        return reject('Error: Canvas is not supported in the current environment');\n      }\n    });\n  }\n}\n"],"names":[],"mappings":"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"}